---
interface Props {
  id: string;
  type?: 'manuel' | 'ia';
  nom_modele: string;
  nom_personnalisation: string;
  taille?: number;
  prix?: number;
  image?: string;
  svgCode?: string;
  verres?: string;
  cercles?: string;
  branche?: string;
  created?: string;
}

const { 
  id, 
  type = 'manuel',
  nom_modele, 
  nom_personnalisation, 
  taille, 
  prix, 
  image,
  svgCode,
  verres,
  cercles,
  branche,
  created
} = Astro.props;

// Badge de personnalisation
const isIA = type === 'ia';
const hasCustomization = nom_personnalisation && nom_personnalisation.trim() !== '';

// Formater la date
const formatDate = (dateString?: string) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
};
---

<div class="block relative bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-200 transition-all duration-300 no-underline text-inherit h-full hover:shadow-xl lunette-card" data-id={id}>
  <!-- Date badge en haut à droite -->
  {created && (
    <div class="absolute top-4 right-4 bg-gray-800 text-white px-3 py-1 rounded-full text-[0.65rem] font-medium z-10">
      {formatDate(created)}
    </div>
  )}
  
  <!-- Image Section avec fond gris clair - Cliquable pour voir les détails -->
  <a href={`/lunette/${id}`} class="w-full h-[280px] bg-gray-50 flex items-center justify-center overflow-hidden p-8 no-underline">
    {isIA && svgCode ? (
      <div class="w-full h-full flex items-center justify-center" set:html={svgCode} />
    ) : image ? (
      <img src={image} alt={nom_personnalisation || nom_modele} class="w-full h-full object-contain" />
    ) : (
      <svg viewBox="0 0 200 80" xmlns="http://www.w3.org/2000/svg" class="w-4/5 h-auto text-gray-300">
        <g stroke="currentColor" stroke-width="2" fill="none">
          <circle cx="50" cy="40" r="25" />
          <circle cx="150" cy="40" r="25" />
          <line x1="75" y1="40" x2="125" y2="40" />
          <line x1="25" y1="40" x2="10" y2="35" />
          <line x1="175" y1="40" x2="190" y2="35" />
        </g>
      </svg>
    )}
  </a>
  
  <!-- Content Section -->
  <div class="p-6">
    <a href={`/lunette/${id}`} class="no-underline">
      <h3 class="font-body text-xl font-bold text-gray-900 m-0 mb-2 overflow-hidden text-ellipsis whitespace-nowrap card-title hover:text-brand-brown transition-colors">
        {nom_personnalisation || nom_modele}
      </h3>
      <p class="font-subtitle text-sm text-gray-500 m-0 mb-4 card-subtitle">
        {isIA ? 'Généré par IA' : `Modèle ${nom_modele}`}
      </p>
    </a>
    
    <!-- Details -->
    {!isIA && (
      <ul class="list-none p-0 m-0 mb-6 space-y-2">
        {taille && (
          <li class="font-body text-sm text-gray-700 flex items-center">
            <span class="w-1.5 h-1.5 rounded-full bg-gray-900 mr-2"></span>
            Taille: {taille}-18
          </li>
        )}
        {verres && (
          <li class="font-body text-sm text-gray-700 flex items-center">
            <span class="w-1.5 h-1.5 rounded-full bg-gray-900 mr-2"></span>
            {verres}
          </li>
        )}
        {cercles && (
          <li class="font-body text-sm text-gray-700 flex items-center">
            <span class="w-1.5 h-1.5 rounded-full bg-gray-900 mr-2"></span>
            Monture: {cercles}
          </li>
        )}
      </ul>
    )}
    
    <!-- Footer: Price + Actions -->
    <div class="flex justify-between items-center">
      {prix ? (
        <span class="font-body text-2xl font-bold text-gray-900">{prix} €</span>
      ) : (
        <span class="font-body text-sm text-gray-500 italic">Prix non défini</span>
      )}
      
      <div class="flex gap-2">
        <a
          href={`/lunette/${id}`}
          class="action-btn bg-white border border-gray-300 rounded-lg p-2 cursor-pointer transition-all duration-200 text-gray-700 flex items-center justify-center hover:bg-gray-50 hover:border-gray-400" 
          aria-label="Voir les détails"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </a>
        <a
          href={`/configurateur?edit=${id}`}
          class="action-btn copy-btn bg-white border border-gray-300 rounded-lg p-2 cursor-pointer transition-all duration-200 text-gray-700 flex items-center justify-center hover:bg-gray-50 hover:border-gray-400" 
          aria-label="Modifier"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        </a>
        <button 
          class="action-btn delete-btn bg-white border border-gray-300 rounded-lg p-2 cursor-pointer transition-all duration-200 text-red-600 flex items-center justify-center hover:bg-red-50 hover:border-red-400" 
          aria-label="Supprimer"
          data-id={id}
          data-type={type}
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .action-btn {
    position: relative;
    z-index: 20;
  }
  
  .lunette-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .lunette-card:hover {
    transform: translateY(-4px);
  }

  /* Rendre les zones cliquables plus évidentes */
  .lunette-card a:not(.action-btn) {
    cursor: pointer;
  }

  .lunette-card a:not(.action-btn):hover img,
  .lunette-card a:not(.action-btn):hover svg {
    transform: scale(1.05);
    transition: transform 0.3s ease;
  }
</style>

<script>
  import { deleteLunette } from '../utils/pb';

  // Gestion du bouton supprimer
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const button = e.currentTarget as HTMLElement;
      const id = button.getAttribute('data-id');
      const type = button.getAttribute('data-type') as 'manuel' | 'ia';
      
      if (!id) return;
      
      if (confirm('⚠️ Êtes-vous sûr de vouloir supprimer cette lunette ?')) {
        try {
          const result = await deleteLunette(id, type);
          
          if (result.success) {
            // Supprimer la carte du DOM avec animation
            const card = button.closest('.lunette-card') as HTMLElement;
            if (card) {
              card.style.transition = 'all 0.3s ease';
              card.style.opacity = '0';
              card.style.transform = 'scale(0.8)';
              
              setTimeout(() => {
                card.remove();
                // Recharger la page pour mettre à jour le compteur
                window.location.reload();
              }, 300);
            }
          } else {
            alert('❌ Erreur lors de la suppression: ' + result.error);
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('❌ Erreur lors de la suppression');
        }
      }
    });
  });
</script>
