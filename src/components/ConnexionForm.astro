---
import googleIcon from '../assets/images/google.webp';
import securiteIcon from '../assets/securite.svg';
---

<div class="w-full max-w-lg mx-auto">
  <div class="bg-white rounded-2xl shadow-xl p-10 min-h-[650px]">
    <!-- Nudge de sécurité -->
    <div class="flex items-center gap-3 bg-[#68503B]/10 rounded-xl p-4 border border-[#68503B]/20 mb-6">
      <img src={securiteIcon.src} alt="Sécurité" class="w-10 h-10 flex-shrink-0" />
      <p class="text-sm text-gray-700">
        <span class="font-semibold">Connexion 100 % sécurisée</span>
      </p>
    </div>

    <div class="relative bg-gray-200 rounded-full p-1 mb-8">
      <div 
        id="slider"
        class="absolute top-1 bottom-1 left-1 w-[calc(50%-0.25rem)] bg-[#9B8B7E] rounded-full transition-all duration-300 ease-in-out shadow-md"
      ></div>
      
      <div class="relative flex gap-1">
        <button 
          id="connexion-tab"
          class="flex-1 py-3 rounded-full font-medium transition-colors duration-300 z-10 text-white"
          data-tab="connexion"
        >
          Connexion
        </button>
        <button 
          id="inscription-tab"
          class="flex-1 py-3 rounded-full font-medium transition-colors duration-300 z-10 text-gray-700"
          data-tab="inscription"
        >
          Inscription
        </button>
      </div>
    </div>

    <div id="error-message-connexion" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
    <div id="success-message-connexion" class="hidden mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg text-sm"></div>
    <form id="connexion-form" class="space-y-6">
      <!-- Email -->
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
          Email
        </label>
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
          </svg>
          <input 
            type="email" 
            id="email" 
            name="email"
            placeholder="votre@email.com"
            class="w-full pl-12 pr-4 py-3 bg-gray-100 border-0 rounded-lg focus:ring-2 focus:ring-[#92400e] outline-none transition-all"
            required
          />
        </div>
      </div>

      <!-- Mot de passe -->
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
          Mot de passe
        </label>
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
          </svg>
          <input 
            type="password" 
            id="password" 
            name="password"
            placeholder="••••••••"
            class="w-full pl-12 pr-4 py-3 bg-gray-100 border-0 rounded-lg focus:ring-2 focus:ring-[#92400e] outline-none transition-all"
            required
          />
        </div>
      </div>

      <div class="text-right">
        <a href="/mot-de-passe-oublie" class="text-sm text-gray-600 hover:text-[#92400e] transition-colors">
          Mot de passe oublié ?
        </a>
      </div>

      <button 
        type="submit"
        id="submit-btn-connexion"
        class="w-full bg-gray-900 text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Se connecter
      </button>
    </form>

    <!-- Séparateur -->
    <div class="my-8 text-center">
      <span class="text-sm text-gray-500">Ou continuer avec:</span>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <button 
        id="google-btn"
        type="button"
        class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
        aria-label="Se connecter avec Google"
      >
        <img src={googleIcon.src} alt="Google" class="w-5 h-5" />
        <span class="text-sm font-medium text-gray-700">Google</span>
      </button>
      <button 
        class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
        aria-label="Se connecter avec Apple"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M11.182.008C11.148-.03 9.923.023 8.857 1.18c-1.066 1.156-.902 2.482-.878 2.516.024.034 1.52.087 2.475-1.258.955-1.345.762-2.391.728-2.43Zm3.314 11.733c-.048-.096-2.325-1.234-2.113-3.422.212-2.189 1.675-2.789 1.698-2.854.023-.065-.597-.79-1.254-1.157a3.692 3.692 0 0 0-1.563-.434c-.108-.003-.483-.095-1.254.116-.508.139-1.653.589-1.968.607-.316.018-1.256-.522-2.267-.665-.647-.125-1.333.131-1.824.328-.49.196-1.422.754-2.074 2.237-.652 1.482-.311 3.83-.067 4.56.244.729.625 1.924 1.273 2.796.576.984 1.34 1.667 1.659 1.899.319.232 1.219.386 1.843.067.502-.308 1.408-.485 1.766-.472.357.013 1.061.154 1.782.539.571.197 1.111.115 1.652-.105.541-.221 1.324-1.059 2.238-2.758.347-.79.505-1.217.473-1.282Z"/>
          <path d="M11.182.008C11.148-.03 9.923.023 8.857 1.18c-1.066 1.156-.902 2.482-.878 2.516.024.034 1.52.087 2.475-1.258.955-1.345.762-2.391.728-2.43Z"/>
        </svg>
        <span class="text-sm font-medium text-gray-700">Apple</span>
      </button>
    </div>
  </div>
</div>

<script>
  import pb from '../utils/pb';

  const connexionTab = document.getElementById('connexion-tab');
  const inscriptionTab = document.getElementById('inscription-tab');
  const slider = document.getElementById('slider');
  const form = document.getElementById('connexion-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn-connexion') as HTMLButtonElement;
  const errorMessage = document.getElementById('error-message-connexion');
  const successMessage = document.getElementById('success-message-connexion');
  
  connexionTab?.addEventListener('click', () => {
  });
  
  inscriptionTab?.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('changeAuthView', { detail: 'inscription' }));
  });

  // OAuth Google
  const googleBtn = document.getElementById('google-btn');
  
  googleBtn?.addEventListener('click', async () => {
    try {
      const authData = await pb.collection('users').authWithOAuth2({ provider: 'google' });
      
      if (authData) {
        if (successMessage) {
          successMessage.textContent = 'Connexion avec Google réussie !';
          successMessage.classList.remove('hidden');
        }
        
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
      }
    } catch (error: any) {
      console.error('Erreur OAuth Google:', error);
      if (errorMessage) {
        errorMessage.textContent = error.message || 'Erreur lors de la connexion avec Google';
        errorMessage.classList.remove('hidden');
      }
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    errorMessage?.classList.add('hidden');
    successMessage?.classList.add('hidden');
    
    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Connexion en cours...';
    
    try {
      const authData = await pb.collection('users').authWithPassword(email, password);
      
      if (successMessage) {
        successMessage.textContent = 'Connexion réussie ! Redirection...';
        successMessage.classList.remove('hidden');
      }
      
      setTimeout(() => {
        window.location.href = '/';
      }, 1000);
      
    } catch (error: any) {
      console.error('Erreur de connexion:', error);
      
      let errorText = 'Email ou mot de passe incorrect.';
      
      if (error.response?.data) {
        const data = error.response.data;
        if (data.message) {
          errorText = data.message;
        }
      }
      
      if (errorMessage) {
        errorMessage.textContent = errorText;
        errorMessage.classList.remove('hidden');
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Se connecter';
    }
  });
</script>
