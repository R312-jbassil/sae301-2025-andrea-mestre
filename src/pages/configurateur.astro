---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import ConfiguratorNav from '../components/ConfiguratorNav.astro';
import LunetteSvg from '../assets/lunette.svg?raw';
import StarsSvg from '../assets/Stars.svg?raw';
import IconLunetteSvg from '../assets/iconlunette.svg?raw';
import Icon3dSvg from '../assets/icon3d.svg?raw';
import IaSvg from '../assets/ia.svg?raw';
import FavoriSvg from '../assets/favori.svg?raw';
import HavaneImg from '../assets/images/havane.webp';
import Etui1Img from '../assets/images/etui1.webp';
import Etui2Img from '../assets/images/etui2.webp';
import ChevronSvg from '../assets/chevron.svg?raw';
---

<Layout title="Configurateur - TAVUE">
	<Header />
	
	<main class="grid lg:grid-cols-2 min-h-[calc(100vh-80px)] bg-white">
		<!-- Section gauche: Visualisation des lunettes -->
		<section class="flex flex-col bg-gray-100 border-r border-gray-200 p-8">
			<!-- Header avec retour et titre -->
			<div class="flex items-center justify-between gap-4 mb-8 flex-wrap">
			<a href="/" class="flex items-center gap-2 px-6 py-3 bg-[#2d2d2d] text-white rounded-lg text-xs font-semibold tracking-wider hover:bg-black transition-all no-underline">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M19 12H5M12 19l-7-7 7-7"/>
				</svg>
				RETOUR
			</a>
			
			<div class="flex-1 text-center">
				<div id="edit-mode-badge" class="hidden px-3 py-1 bg-orange-500 text-white text-xs font-bold rounded-full mb-2">
					‚úèÔ∏è MODE √âDITION
				</div>
			
			</div>				<button class="reinitialiser-btn flex items-center gap-2 px-6 py-3 bg-white text-black border-2 border-black rounded-full text-xs font-semibold tracking-wider hover:bg-black hover:text-white transition-all">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
					</svg>
					R√âINITIALISER
				</button>
			</div>

			<!-- Boutons d'action -->
			<div class="flex gap-4 justify-center mb-8 flex-wrap">
				<button class="flex items-center gap-2 px-6 py-3 bg-[#2A2017] text-white rounded-full text-sm font-medium hover:bg-[#1a1410] hover:-translate-y-0.5 hover:shadow-lg transition-all">
					<span class="flex items-center justify-center w-[18px] h-[18px]" set:html={IconLunetteSvg}></span>
					Essayer
				</button>
				<button class="flex items-center gap-2 px-6 py-3 bg-[#2A2017] text-white rounded-full text-sm font-medium hover:bg-[#1a1410] hover:-translate-y-0.5 hover:shadow-lg transition-all">
					<span class="flex items-center justify-center w-[18px] h-[18px]" set:html={Icon3dSvg}></span>
					Voir en 3D
				</button>
				<button class="flex items-center gap-2 px-6 py-3 bg-[#2A2017] text-white rounded-full text-sm font-medium hover:bg-[#1a1410] hover:-translate-y-0.5 hover:shadow-lg transition-all">
					<span class="flex items-center justify-center w-[18px] h-[18px]" set:html={IaSvg}></span>
					G√©n√©rer par IA
				</button>
			</div>

			<!-- Container pour les lunettes SVG -->
			<div class="relative w-full h-[450px] flex items-center justify-center bg-white rounded-2xl mb-6 overflow-hidden">
				<button class="absolute top-1/2 -translate-y-1/2 left-6 w-12 h-12 rounded-full flex items-center justify-center hover:bg-black/5 transition-all text-[#2d2d2d] z-10 bg-transparent border-0 cursor-pointer" aria-label="Pr√©c√©dent">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M15 18l-6-6 6-6"/>
					</svg>
				</button>
				
				<div id="glasses-container" class="w-full h-full flex items-center justify-center p-8" set:html={LunetteSvg}></div>

				<button class="absolute top-1/2 -translate-y-1/2 right-6 w-12 h-12 rounded-full flex items-center justify-center hover:bg-black/5 transition-all text-[#2d2d2d] z-10 bg-transparent border-0 cursor-pointer" aria-label="Suivant">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M9 18l6-6-6-6"/>
					</svg>
				</button>
			</div>

			<div class="flex gap-2 justify-center">
				<span class="dot w-2.5 h-2.5 rounded-full bg-[#2d2d2d] cursor-pointer hover:bg-gray-500 transition-colors"></span>
				<span class="dot w-2.5 h-2.5 rounded-full bg-gray-300 cursor-pointer hover:bg-gray-500 transition-colors"></span>
				<span class="dot w-2.5 h-2.5 rounded-full bg-gray-300 cursor-pointer hover:bg-gray-500 transition-colors"></span>
				<span class="dot w-2.5 h-2.5 rounded-full bg-gray-300 cursor-pointer hover:bg-gray-500 transition-colors"></span>
			</div>
		</section>

		<!-- Section droite: Configuration -->
		<section class="flex flex-col overflow-y-auto max-h-[calc(100vh-80px)]">
			<!-- Bandeau WAYFARER -->
			<div class="bg-[#2A2017] text-white p-5 flex items-center justify-between gap-6 rounded-2xl m-6 flex-wrap">
				<div class="flex items-center gap-6 flex-1 flex-wrap">
					<span class="text-xl font-bold tracking-wider whitespace-nowrap" style="font-family: var(--font-title);">WAYFARER</span>
					<div class="flex items-center gap-2 bg-white text-black px-4 py-2 rounded-lg text-sm font-medium">
						<span class="flex items-center justify-center w-5 h-5" set:html={StarsSvg}></span>
						<span>Limit√© ! Ce mod√®le est limit√©. D√©p√™chez-vous !</span>
					</div>
				</div>
				<button class="flex items-center gap-2 px-6 py-3 bg-white text-black rounded-full text-sm font-semibold tracking-wide hover:bg-gray-100 hover:translate-x-1 transition-all whitespace-nowrap">
					CHANGER DE MOD√àLE
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M9 18l6-6-6-6"/>
					</svg>
				</button>
			</div>

			<!-- Titre personnalisation -->
			<div class="px-8 py-8 text-center">
				<h2 class="text-base font-normal uppercase m-0 text-gray-900 leading-relaxed" style="font-family: var(--font-subtitle); letter-spacing: var(--letter-spacing-subtitle); line-height: var(--line-height-subtitle);">
					VOTRE PAIRE, VOTRE STYLE. PERSONNALISEZ-LA POUR QU'ELLE VOUS RESSEMBLE √Ä 100 %.
				</h2>
			</div>

			<!-- Input nom de la paire -->
			<div class="px-8 pb-8">
				<input 
					type="text" 
					id="pair-name" 
					class="w-full px-6 py-4 bg-gray-100 border border-gray-200 rounded-xl text-base text-gray-500 transition-all outline-none focus:bg-white focus:border-gray-400 focus:text-gray-900 placeholder:text-gray-400" 
					placeholder="Donnez un nom √† votre paire de lunette !"
					style="font-family: var(--font-body);"
				/>
			</div>

			<!-- Sous-menu de navigation sticky -->
			<ConfiguratorNav />

			<div class="flex flex-col gap-12 px-8 pb-8">

				<!-- √âtape 1: TAILLE -->
				<div id="step-1" class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow scroll-mt-24">
					<div class="flex items-center justify-between px-6 py-4 bg-white cursor-pointer hover:bg-gray-50 transition-colors">
						<span class="font-semibold tracking-wide text-lg" style="font-family: var(--font-subtitle);">1. TAILLE</span>
					</div>
					<div class="px-6 py-6 bg-gray-50 border-t border-gray-200">
						<div class="flex items-center justify-between">
							<span class="text-base font-medium" style="font-family: var(--font-body);">TAILLE</span>
							<div class="flex items-center gap-4">
								<span class="text-base font-normal" style="font-family: var(--font-body);" id="size-value">60-18</span>
								<div class="flex items-center gap-2">
									<button class="size-prev-btn w-10 h-10 flex items-center justify-center bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-all" aria-label="Taille pr√©c√©dente">
										<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M15 18l-6-6 6-6"/>
										</svg>
									</button>
									<button class="size-next-btn w-10 h-10 flex items-center justify-center bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-all" aria-label="Taille suivante">
										<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M9 18l6-6-6-6"/>
										</svg>
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- √âtape 2: VERRES -->
				<div id="step-2" class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow scroll-mt-24">
					<div class="flex items-center justify-between px-6 py-4 bg-white cursor-pointer hover:bg-gray-50 transition-colors">
						<span class="font-semibold tracking-wide text-lg" style="font-family: var(--font-subtitle);">2. VERRES</span>
					</div>
					<div class="px-6 py-6 bg-gray-50 border-t border-gray-200">
						<div class="flex flex-col gap-3">
							<label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-white transition-colors">
								<input type="radio" name="lenses" value="clear" checked class="w-[18px] h-[18px] cursor-pointer">
								<span>Verres anti-lumi√®re bleue</span>
							</label>
							<label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-white transition-colors">
								<input type="radio" name="lenses" value="glass" class="w-[18px] h-[18px] cursor-pointer">
								<span>Verres de vues</span>
							</label>
							<label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-white transition-colors">
								<input type="radio" name="lenses" value="sun" class="w-[18px] h-[18px] cursor-pointer">
								<span>Verres pour lunette de soleil</span>
							</label>
						</div>
					</div>
				</div>

				<!-- √âtape 3: CERCLES -->
				<div id="step-3" class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow scroll-mt-24">
					<div class="flex items-center justify-between px-6 py-4 bg-white cursor-pointer hover:bg-gray-50 transition-colors">
						<span class="font-semibold tracking-wide text-lg" style="font-family: var(--font-subtitle);">3. CERCLES</span>
						<div id="cercles-badge" class="hidden items-center gap-2 bg-black text-white px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap">
							<span style="font-family: var(--font-body);">LE MOD√àLE LE PLUS CHOISI PAR NOTRE COMMUNAUT√â</span>
						</div>
					</div>
					<div class="px-6 py-6 bg-gray-50 border-t border-gray-200">
						<div class="grid grid-cols-4 gap-6">
							<button class="color-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105" data-color="#f5f5f5" data-favorite="false" title="Blanc">
								<div class="w-full aspect-square border border-gray-200 rounded-lg" style="background-color: #f5f5f5;"></div>
								<span class="text-sm" style="font-family: var(--font-body);">Blanc</span>
							</button>
							<button class="color-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105 relative" data-color="#000000" data-favorite="true" title="Noir">
								<span class="absolute -top-6 right-0 text-yellow-400 text-4xl">‚òÖ</span>
								<div class="w-full aspect-square border border-gray-200 rounded-lg" style="background-color: #000000;"></div>
								<span class="text-sm" style="font-family: var(--font-body);">Noir</span>
							</button>
							<button class="color-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105 relative" data-color="#f4c542" data-favorite="false" title="Or">
								<div class="w-full aspect-square border border-gray-200 rounded-lg" style="background-color: #f4c542;"></div>
								<span class="text-sm" style="font-family: var(--font-body);">Or</span>
							</button>
							<button class="color-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105" data-color="#e6b8a8" data-favorite="false" title="Cuivre Brillant">
								<div class="w-full aspect-square border border-gray-200 rounded-lg" style="background-color: #e6b8a8;"></div>
								<span class="text-sm" style="font-family: var(--font-body);">Cuivre Brillant</span>
							</button>
						</div>
					</div>
				</div>

				<!-- √âtape 4: BRANCHES -->
				<div id="step-4" class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow scroll-mt-24">
					<div class="flex items-center justify-between px-6 py-4 bg-white cursor-pointer hover:bg-gray-50 transition-colors">
						<span class="font-semibold tracking-wide text-lg" style="font-family: var(--font-subtitle);">4. BRANCHES</span>
						<div id="branches-badge" class="hidden items-center gap-2 bg-black text-white px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap">
							<span style="font-family: var(--font-body);">LE MOD√àLE LE PLUS CHOISI PAR NOTRE COMMUNAUT√â</span>
						</div>
					</div>
					<div class="px-6 py-6 bg-gray-50 border-t border-gray-200">
						<div class="grid grid-cols-4 gap-6">
							<button class="color-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105" data-color="transparent" data-part="temples" data-favorite="false" title="Transparent">
								<div class="w-full aspect-square border border-gray-200 rounded-lg bg-white"></div>
								<span class="text-sm" style="font-family: var(--font-body);">Transparent</span>
							</button>
							<button class="color-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105" data-color="#92400e" data-part="temples" data-favorite="false" title="Havane">
								<div class="w-full aspect-square border border-gray-200 rounded-lg overflow-hidden">
									<img src={HavaneImg.src} alt="Havane" class="w-full h-full object-cover" />
								</div>
								<span class="text-sm" style="font-family: var(--font-body);">Havane</span>
							</button>
							<div class="flex flex-col items-center gap-3 relative">
								<span class="absolute -top-6 right-0 text-yellow-400 text-4xl">‚òÖ</span>
								<button class="color-btn w-full cursor-pointer transition-all hover:scale-105" data-color="#000000" data-part="temples" data-favorite="true" title="Noir">
									<div class="w-full aspect-square border border-gray-200 rounded-lg" style="background-color: #000000;"></div>
								</button>
								<span class="text-sm" style="font-family: var(--font-body);">Noir</span>
							</div>
							<button class="color-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105" data-color="#ffffff" data-part="temples" data-favorite="false" title="Blanc">
								<div class="w-full aspect-square border border-gray-200 rounded-lg" style="background-color: #ffffff;"></div>
								<span class="text-sm" style="font-family: var(--font-body);">Blanc</span>
							</button>
						</div>
					</div>
				</div>

				<!-- √âtape 5: √âTUI -->
				<div id="step-5" class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow scroll-mt-24">
					<div class="flex items-center justify-between px-6 py-4 bg-white cursor-pointer hover:bg-gray-50 transition-colors">
						<span class="font-semibold tracking-wide text-lg" style="font-family: var(--font-subtitle);">5. √âTUI</span>
					</div>
					<div class="px-6 py-6 bg-gray-50 border-t border-gray-200">
						<div class="grid grid-cols-2 gap-6">
							<button class="case-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105" data-case="hard">
								<div class="w-full aspect-square border border-gray-200 rounded-lg bg-white overflow-hidden p-4 flex items-center justify-center">
									<img src={Etui1Img.src} alt="√âtui rigide" class="w-full h-full object-contain" />
								</div>
								<span class="text-sm" style="font-family: var(--font-body);">√âtui rigide</span>
							</button>
							<button class="case-btn flex flex-col items-center gap-3 cursor-pointer transition-all hover:scale-105" data-case="soft">
								<div class="w-full aspect-square border border-gray-200 rounded-lg bg-white overflow-hidden p-4 flex items-center justify-center">
									<img src={Etui2Img.src} alt="√âtui souple" class="w-full h-full object-contain" />
								</div>
								<span class="text-sm" style="font-family: var(--font-body);">√âtui souple</span>
							</button>
						</div>
					</div>
				</div>
			</div>

		<!-- Footer avec prix -->
		<div class="sticky bottom-0 bg-[#2A2017] px-8 py-6">
			<div class="flex items-center gap-4 flex-wrap">
				<button class="w-12 h-12 bg-transparent border-0 flex items-center justify-center text-white text-2xl hover:opacity-70 transition-all cursor-pointer" aria-label="Retour">
					<span set:html={ChevronSvg}></span>
				</button>
				<span id="price-display" class="text-3xl font-bold text-white mr-auto" style="font-family: var(--font-title);">146 ‚Ç¨</span>
				<button class="save-btn px-8 py-3 bg-white text-black rounded-full text-sm font-semibold tracking-wider hover:bg-gray-100 transition-all whitespace-nowrap" style="font-family: var(--font-body);">
					ENREGISTRER
				</button>
				<button class="add-to-cart-btn px-8 py-3 bg-white text-black rounded-full text-sm font-semibold tracking-wider hover:bg-gray-100 transition-all whitespace-nowrap" style="font-family: var(--font-body);">
					AJOUTER AU PANIER
				</button>
			</div>
		</div>
		</section>
	</main>
</Layout>

<style>
	/* Styles minimaux - Le reste est g√©r√© par Tailwind */
	#glasses-container svg {
		width: 90%;
		height: auto;
		max-width: 650px;
		transition: all 0.3s ease;
	}

	.dot.active {
		background-color: #2d2d2d !important;
	}

	.color-btn.active > div {
		border-width: 3px !important;
		border-color: black !important;
		border-radius: 0.5rem !important;
	}

	.case-btn.active > div {
		border-width: 3px !important;
		border-color: black !important;
		border-radius: 0.5rem !important;
	}
</style>

<script>
	import { createLunette, updateLunette, getLunette, isUserAuthenticated, type LunetteData } from '../utils/pb';

	// ===== GESTION DES INTERACTIONS =====
	
	// √âtat de la configuration
	let config = {
		nom_modele: 'WAYFARER',
		nom_personnalisation: '',
		size: 'S',
		sizeIndex: 0,
		sizeValue: '60-18',
		lenses: 'Verres anti-lumi√®re bleue', // Libell√© par d√©faut
		frameColor: '#1D1D1B',
		templeColor: '#1D1D1B',
		case: 'soft',
		price: 146,
		lunetteId: null as string | null // Pour stocker l'ID si on √©dite une lunette existante
	};

	// ===== MODE √âDITION : Charger une lunette existante =====
	async function loadLunetteForEdit() {
		// R√©cup√©rer le param√®tre ?edit=id depuis l'URL
		const urlParams = new URLSearchParams(window.location.search);
		const editId = urlParams.get('edit');

		if (editId) {
			try {
				console.log('üîÑ Chargement de la lunette pour √©dition:', editId);
				const result = await getLunette(editId);
				
				if (result.success && result.data) {
					const lunette = result.data;
					
					// Stocker l'ID pour la mise √† jour
					config.lunetteId = lunette.id;
					
					// Charger les donn√©es dans config
					config.nom_modele = lunette.nom_modele || 'WAYFARER';
					config.nom_personnalisation = lunette.nom_personnalisation || '';
					config.price = lunette.prix || 146;
					config.lenses = lunette.verres || 'Verres anti-lumi√®re bleue';
					config.frameColor = lunette.cercles || '#1D1D1B';
					config.templeColor = lunette.branches || '#1D1D1B';
					config.case = lunette.etui || 'soft';
					
					// G√©rer la taille
					if (lunette.taille) {
						const sizeIndex = sizes.findIndex(s => parseInt(s.value.split('-')[0]) === lunette.taille);
						if (sizeIndex !== -1) {
							config.sizeIndex = sizeIndex;
							config.sizeValue = sizes[sizeIndex].value;
						}
					}
					
					console.log('‚úÖ Lunette charg√©e:', config);
					
					// Appliquer les valeurs charg√©es √† l'interface (sera appel√© dans DOMContentLoaded)
					if (document.readyState === 'loading') {
						// Le DOM n'est pas encore pr√™t, applyLoadedConfig sera appel√© plus tard
					} else {
						// Le DOM est d√©j√† pr√™t, appliquer imm√©diatement
						// Note: applyLoadedConfig est d√©fini dans DOMContentLoaded
					}
				} else {
					console.error('‚ùå Erreur lors du chargement:', result.error);
					alert('Erreur lors du chargement de la lunette.');
				}
			} catch (error) {
				console.error('‚ùå Erreur:', error);
				alert('Impossible de charger la lunette.');
			}
		}
	}

	// Tailles disponibles
	const sizes = [
		{ label: '1. TAILLE', value: '60-18' },
		{ label: '2. TAILLE', value: '62-19' },
		{ label: '3. TAILLE', value: '64-20' },
		{ label: '4. TAILLE', value: '66-21' },
		{ label: '5. TAILLE', value: '68-22' }
	];

	// Attendre que le DOM soit charg√©
	document.addEventListener('DOMContentLoaded', () => {
		// R√©cup√©rer le SVG ins√©r√©
		const svgContainer = document.getElementById('glasses-container');
		const svg = svgContainer?.querySelector('svg');
		
		if (!svg) {
			console.error('SVG non trouv√©');
			return;
		}

		// Cibler les √©l√©ments du SVG (les paths avec fill="white" sont les parties modifiables)
		const framePaths = svg.querySelectorAll('path[fill="white"]');
		const strokePaths = svg.querySelectorAll('path[stroke="#1D1D1B"]');

		// ===== FONCTIONS DE MISE √Ä JOUR DU SVG =====
	function updateGlassesSize(sizeIndex: number) {
		config.sizeIndex = sizeIndex;
		config.sizeValue = sizes[sizeIndex].value;

		// Mettre √† jour uniquement l'affichage de la valeur
		const sizeValue = document.getElementById('size-value');
		if (sizeValue) sizeValue.textContent = config.sizeValue;
	}		function updateLensType(type: string) {
			if (!framePaths || framePaths.length === 0) return;

			const lensStyles = {
				'clear': { fill: 'rgba(255, 255, 255, 0.95)', opacity: '0.5' },
				'glass': { fill: 'rgba(200, 220, 255, 0.3)', opacity: '0.6' },
				'sun': { fill: 'rgba(50, 50, 50, 0.8)', opacity: '0.9' }
			};

			const style = lensStyles[type as keyof typeof lensStyles];
			if (style) {
				// Les deux premiers paths sont les verres (left et right lens)
				framePaths.forEach((path) => {
					path.setAttribute('fill', style.fill);
					path.setAttribute('fill-opacity', style.opacity);
				});
				config.lenses = type;
			}
		}

		function updateFrameColor(color: string) {
			if (!strokePaths || strokePaths.length === 0) return;

			// Modifier la couleur du contour
			strokePaths.forEach((path) => {
				path.setAttribute('stroke', color);
			});
			
			config.frameColor = color;
		}

		function updateTempleColor(color: string) {
			if (!strokePaths || strokePaths.length === 0) return;

			// Modifier la couleur des branches (temples)
			strokePaths.forEach((path, index) => {
				// Les branches sont g√©n√©ralement les derniers paths
				if (index >= strokePaths.length - 2) {
					if (color === 'transparent') {
						path.setAttribute('stroke', '#d1d5db');
						path.setAttribute('stroke-dasharray', '5,5');
					} else {
						path.setAttribute('stroke', color);
						path.setAttribute('stroke-dasharray', '0');
					}
				}
			});
			
			config.templeColor = color;
		}

		// ===== GESTION DES BOUTONS DE TAILLE =====
		const sizePrevBtn = document.querySelector('.size-prev-btn');
		const sizeNextBtn = document.querySelector('.size-next-btn');

		sizePrevBtn?.addEventListener('click', () => {
			const newIndex = Math.max(0, config.sizeIndex - 1);
			updateGlassesSize(newIndex);
		});

		sizeNextBtn?.addEventListener('click', () => {
			const newIndex = Math.min(sizes.length - 1, config.sizeIndex + 1);
			updateGlassesSize(newIndex);
		});

		// ===== GESTION DES VERRES =====
		document.querySelectorAll('input[name="lenses"]').forEach(radio => {
			radio.addEventListener('change', (e) => {
				const target = e.target as HTMLInputElement;
				const label = target.closest('label')?.querySelector('span')?.textContent || target.value;
				updateLensType(target.value);
				config.lenses = label.trim(); // Sauvegarder le libell√© exact au lieu de la valeur
			});
		});

		// ===== GESTION DES COULEURS DE CERCLES =====
		const cerclesBadge = document.getElementById('cercles-badge');
		document.querySelectorAll('.color-btn[data-color]:not([data-part])').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.currentTarget as HTMLElement;
				const color = target.getAttribute('data-color');
				const isFavorite = target.getAttribute('data-favorite') === 'true';
				if (!color) return;

				// Mettre √† jour le badge
				if (cerclesBadge) {
					if (isFavorite) {
						cerclesBadge.classList.remove('hidden');
						cerclesBadge.classList.add('flex');
					} else {
						cerclesBadge.classList.add('hidden');
						cerclesBadge.classList.remove('flex');
					}
				}

				// Mise √† jour de l'√©tat actif dans la section cercles
				const section = target.closest('#step-3');
				if (section) {
					section.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
					target.classList.add('active');
					updateFrameColor(color);
				}
			});
		});

		// ===== GESTION DES COULEURS DE BRANCHES =====
		const branchesBadge = document.getElementById('branches-badge');
		document.querySelectorAll('.color-btn[data-part="temples"]').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.currentTarget as HTMLElement;
				const color = target.getAttribute('data-color');
				const isFavorite = target.getAttribute('data-favorite') === 'true';
				if (!color) return;

				// Mettre √† jour le badge
				if (branchesBadge) {
					if (isFavorite) {
						branchesBadge.classList.remove('hidden');
						branchesBadge.classList.add('flex');
					} else {
						branchesBadge.classList.add('hidden');
						branchesBadge.classList.remove('flex');
					}
				}

				// Mise √† jour de l'√©tat actif dans la section branches
				const section = target.closest('#step-4');
				if (section) {
					section.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
					target.classList.add('active');
					updateTempleColor(color);
				}
			});
		});

		// ===== GESTION DES √âTUIS =====
		document.querySelectorAll('.case-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.currentTarget as HTMLElement;
				const caseType = target.getAttribute('data-case');
				if (!caseType) return;

				document.querySelectorAll('.case-btn').forEach(b => b.classList.remove('active'));
				target.classList.add('active');
				config.case = caseType;
			});
		});

		// ===== GESTION DE L'EXPANSION DES SECTIONS =====
		document.querySelectorAll('.step-header').forEach(header => {
			header.addEventListener('click', (e) => {
				const step = (e.currentTarget as HTMLElement).closest('.config-step');
				if (step) {
					step.classList.toggle('expanded');
				}
			});
		});

	// ===== BOUTON R√âINITIALISER =====
	document.querySelector('.reinitialiser-btn')?.addEventListener('click', () => {
		// R√©initialiser la configuration
		config = {
			nom_modele: 'WAYFARER',
			nom_personnalisation: '',
			size: 'S',
			sizeIndex: 0,
			sizeValue: '60-18',
			lenses: 'Verres anti-lumi√®re bleue',
			frameColor: '#1D1D1B',
			templeColor: '#1D1D1B',
			case: 'soft',
			price: 146,
			lunetteId: null
		};
		
		// R√©initialiser l'interface
		updateGlassesSize(0);
		updateLensType('clear');
		updateFrameColor('#1D1D1B');
		updateTempleColor('#1D1D1B');

		// R√©initialiser tous les boutons actifs
		document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
		document.querySelectorAll('.case-btn').forEach(b => b.classList.remove('active'));
		
		// R√©initialiser les radio buttons des verres
		const clearLensRadio = document.querySelector('input[name="lenses"][value="clear"]') as HTMLInputElement;
		if (clearLensRadio) {
			clearLensRadio.checked = true;
		}
		
		// R√©initialiser le nom
		const pairNameInput = document.getElementById('pair-name') as HTMLInputElement;
		if (pairNameInput) {
			pairNameInput.value = '';
		}
		
		// R√©initialiser le titre
		const modelTitle = document.querySelector('.model-title');
		if (modelTitle) {
			modelTitle.textContent = 'NOM DE VOTRE PAIRE';
		}
		
		// R√©initialiser le localStorage
		localStorage.removeItem('pair-name');
		localStorage.removeItem('glasses-config');
		
		// Masquer les badges
		const cerclesBadge = document.getElementById('cercles-badge');
		const branchesBadge = document.getElementById('branches-badge');
		const editBadge = document.getElementById('edit-mode-badge');
		
		if (cerclesBadge) {
			cerclesBadge.classList.add('hidden');
			cerclesBadge.classList.remove('flex');
		}
		if (branchesBadge) {
			branchesBadge.classList.add('hidden');
			branchesBadge.classList.remove('flex');
		}
		if (editBadge) {
			editBadge.classList.add('hidden');
			editBadge.classList.remove('inline-block');
		}
		
		// R√©initialiser le prix
		const priceDisplay = document.getElementById('price-display');
		if (priceDisplay) {
			priceDisplay.textContent = '146 ‚Ç¨';
		}
		
		// R√©initialiser le texte du bouton sauvegarder
		const saveBtn = document.querySelector('.save-btn');
		if (saveBtn) {
			saveBtn.textContent = 'ENREGISTRER';
		}
		
		// R√©initialiser le carousel
		currentSlide = 0;
		updateCarousel();
		
		console.log('‚úÖ Configuration compl√®tement r√©initialis√©e');
	});

		// ===== BOUTON CHANGER DE MOD√àLE =====
		document.querySelector('.change-model-btn')?.addEventListener('click', () => {
			// Rediriger vers la page de s√©lection de mod√®les
			window.location.href = '/modeles';
		});

	// ===== INPUT NOM DE LA PAIRE =====
	const pairNameInput = document.getElementById('pair-name') as HTMLInputElement;
	pairNameInput?.addEventListener('input', (e) => {
		const target = e.target as HTMLInputElement;
		const pairName = target.value;
		
		// Mettre √† jour le config
		config.nom_personnalisation = pairName;
		
		// Mettre √† jour le titre si vous voulez afficher le nom en temps r√©el
		const modelTitle = document.querySelector('.model-title h1');
		if (modelTitle && pairName.trim()) {
			modelTitle.textContent = pairName.toUpperCase();
		} else if (modelTitle) {
			modelTitle.textContent = 'NOM DE VOTRE PAIRE';
		}
		
		// Sauvegarder dans la config
		localStorage.setItem('pair-name', pairName);
	});		// Charger le nom sauvegard√© au chargement
		const savedName = localStorage.getItem('pair-name');
		if (savedName && pairNameInput) {
			pairNameInput.value = savedName;
			const modelTitle = document.querySelector('.model-title h1');
			if (modelTitle && savedName.trim()) {
				modelTitle.textContent = savedName.toUpperCase();
			}
		}

	// ===== BOUTON SAUVEGARDER =====
	document.querySelector('.save-btn')?.addEventListener('click', async () => {
		try {
			// V√©rifier si l'utilisateur est connect√©
			if (!isUserAuthenticated()) {
				alert('‚ùå Vous devez √™tre connect√© pour sauvegarder une lunette.\n\nVeuillez vous connecter d\'abord.');
				// Rediriger vers la page de connexion
				window.location.href = '/connexion';
				return;
			}

			// R√©cup√©rer le nom personnalis√©
			const pairNameInput = document.getElementById('pair-name') as HTMLInputElement;
			const nomPersonnalisation = pairNameInput?.value?.trim() || '';

			// Extraire le num√©ro de taille (ex: "60-18" -> 60)
			const tailleNumber = parseInt(config.sizeValue.split('-')[0]);

			// Mapper les valeurs vers le sch√©ma PocketBase
			const lunetteData: LunetteData = {
				nom_modele: config.nom_modele,
				nom_personnalisation: nomPersonnalisation || `${config.nom_modele} - ${new Date().toLocaleDateString()}`,
				prix: config.price,
				description: `Verres: ${config.lenses}, Cercles: ${config.frameColor}, Branches: ${config.templeColor}, √âtui: ${config.case}`,
				taille: tailleNumber,
				verres: config.lenses,
				cercles: config.frameColor,
				branches: config.templeColor,
				etui: config.case,
				origine_lunette: 'configurateur'
			};

		// Sauvegarder dans PocketBase
		if (config.lunetteId) {
			// Mise √† jour si l'ID existe
			const result = await updateLunette(config.lunetteId, lunetteData);
			if (result.success) {
				alert('‚úÖ Configuration mise √† jour avec succ√®s!');
			} else {
				throw new Error(result.error);
			}
		} else {
			// Cr√©ation d'une nouvelle entr√©e
			const result = await createLunette(lunetteData);
			if (result.success && result.data) {
				config.lunetteId = result.data.id;
				alert('‚úÖ Configuration sauvegard√©e avec succ√®s!');
			} else {
				throw new Error(result.error);
			}
		}			console.log('‚úÖ Sauvegard√© dans PocketBase:', lunetteData);

			// Optionnel: sauvegarder aussi en localStorage comme backup
			localStorage.setItem('glasses-config', JSON.stringify(config));

		} catch (error) {
			console.error('‚ùå Erreur lors de la sauvegarde:', error);
			alert('‚ùå Erreur lors de la sauvegarde. Veuillez r√©essayer.');
		}
	});		// ===== BOUTON AJOUTER AU PANIER =====
		document.querySelector('.add-to-cart-btn')?.addEventListener('click', () => {
			console.log('Ajout au panier:', config);
			alert('Article ajout√© au panier!');
		});

		// ===== NAVIGATION CAROUSEL =====
		let currentSlide = 0;
		const totalSlides = 4;

		document.querySelector('.prev-btn')?.addEventListener('click', () => {
			currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
			updateCarousel();
		});

		document.querySelector('.next-btn')?.addEventListener('click', () => {
			currentSlide = (currentSlide + 1) % totalSlides;
			updateCarousel();
		});

		// Ajouter la navigation par les dots
		document.querySelectorAll('.dot').forEach((dot, index) => {
			dot.addEventListener('click', () => {
				currentSlide = index;
				updateCarousel();
			});
		});

		function updateCarousel() {
			// Mise √† jour des dots
			document.querySelectorAll('.dot').forEach((dot, index) => {
				dot.classList.toggle('active', index === currentSlide);
			});

			// Rotation ou changement de vue (simulation)
			if (svg) {
				const rotations = [0, 15, 30, 45];
				svg.style.transform = `scale(${config.size === 'S' ? 0.7 : config.size === 'M' ? 0.85 : config.size === 'L' ? 1.0 : config.size === 'XL' ? 1.15 : 1.3}) rotateY(${rotations[currentSlide]}deg)`;
			}
		}

		// ===== NAVIGATION PAR SOUS-MENU =====
		const configSection = document.querySelector('section.flex.flex-col.overflow-y-auto');
		
		document.querySelectorAll('.step-nav-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.currentTarget as HTMLElement;
				const stepNumber = target.getAttribute('data-step');
				if (!stepNumber) return;

				// Mettre √† jour l'√©tat actif du sous-menu
				document.querySelectorAll('.step-nav-btn').forEach(b => b.classList.remove('active'));
				target.classList.add('active');

				// Scroller vers l'√©tape correspondante
				const stepElement = document.getElementById(`step-${stepNumber}`);
				if (stepElement && configSection) {
					// Calculer la position relative √† la section scrollable
					const sectionRect = configSection.getBoundingClientRect();
					const stepRect = stepElement.getBoundingClientRect();
					const currentScroll = configSection.scrollTop;
					const targetScroll = currentScroll + stepRect.top - sectionRect.top - 150; // 150px offset pour le menu sticky
					
					configSection.scrollTo({
						top: targetScroll,
						behavior: 'smooth'
					});
				}
			});
		});

		// Observer pour mettre √† jour le bouton actif en fonction du scroll
		const observerOptions = {
			root: configSection,
			rootMargin: '-100px 0px -50% 0px',
			threshold: 0
		};

		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					const stepId = entry.target.id;
					const stepNumber = stepId.replace('step-', '');
					
					// Mettre √† jour le bouton actif
					document.querySelectorAll('.step-nav-btn').forEach(btn => {
						btn.classList.remove('active');
						if (btn.getAttribute('data-step') === stepNumber) {
							btn.classList.add('active');
						}
					});
				}
			});
		}, observerOptions);

		// Observer toutes les √©tapes
		document.querySelectorAll('[id^="step-"]').forEach(step => {
			observer.observe(step);
		});

		// ===== FONCTION POUR APPLIQUER LA CONFIG CHARG√âE =====
		function applyLoadedConfig() {
			// Mettre √† jour l'input du nom
			const pairNameInput = document.getElementById('pair-name') as HTMLInputElement;
			if (pairNameInput) {
				pairNameInput.value = config.nom_personnalisation;
			}
			
			// Mettre √† jour le titre
			const modelTitle = document.querySelector('.model-title h1');
			if (modelTitle && config.nom_personnalisation) {
				modelTitle.textContent = config.nom_personnalisation.toUpperCase();
			}
			
			// Appliquer les valeurs au SVG et √† l'interface
			updateGlassesSize(config.sizeIndex);
			updateLensType(config.lenses);
			updateFrameColor(config.frameColor);
			updateTempleColor(config.templeColor);
			
			// S√©lectionner le bon radio button pour les verres
			document.querySelectorAll('input[name="lenses"]').forEach(radio => {
				const label = radio.closest('label')?.querySelector('span')?.textContent?.trim();
				if (label === config.lenses) {
					(radio as HTMLInputElement).checked = true;
				}
			});
			
			// Mettre √† jour l'√©tui s√©lectionn√©
			document.querySelectorAll('[data-case]').forEach(btn => {
				const caseType = btn.getAttribute('data-case');
				if (caseType === config.case) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
			
			// Mettre √† jour les boutons de couleur actifs
			document.querySelectorAll('[data-frame-color]').forEach(btn => {
				const color = btn.getAttribute('data-frame-color');
				if (color === config.frameColor) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
			
			document.querySelectorAll('[data-temple-color]').forEach(btn => {
				const color = btn.getAttribute('data-temple-color');
				if (color === config.templeColor) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
			
		// Mettre √† jour le prix affich√©
		const priceDisplay = document.getElementById('price-display');
		if (priceDisplay) {
			priceDisplay.textContent = `${config.price} ‚Ç¨`;
		}
		
		// Afficher le badge MODE √âDITION
		const editBadge = document.getElementById('edit-mode-badge');
		if (editBadge && config.lunetteId) {
			editBadge.classList.remove('hidden');
			editBadge.classList.add('inline-block');
		}
		
		// Changer le texte du bouton "ENREGISTRER" ‚Üí "ENREGISTRER LES MODIFICATIONS"
		const saveBtn = document.querySelector('.save-btn');
		if (saveBtn && config.lunetteId) {
			saveBtn.textContent = 'ENREGISTRER LES MODIFICATIONS';
		}
		
		console.log('‚úÖ Interface mise √† jour avec les donn√©es charg√©es');
	}		// Initialisation
		updateLensType('clear');
		updateFrameColor('#1D1D1B');
		updateTempleColor('#1D1D1B');
		updateGlassesSize(0);
		
		// Initialiser le libell√© des verres par d√©faut
		const defaultLensRadio = document.querySelector('input[name="lenses"][value="clear"]') as HTMLInputElement;
		if (defaultLensRadio) {
			const defaultLabel = defaultLensRadio.closest('label')?.querySelector('span')?.textContent || 'Verres anti-lumi√®re bleue';
			config.lenses = defaultLabel.trim();
		}

		// ===== CHARGER UNE LUNETTE EN MODE √âDITION =====
		loadLunetteForEdit();
	});
</script>
